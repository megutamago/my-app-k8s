- name: shell
  shell: curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

- name: shell
  shell: helm repo add cilium https://helm.cilium.io/

- name: Execute helm
  shell: |
    helm install cilium cilium/cilium \
        --version 1.15.0-pre.2 \
        --namespace kube-system \
        --set l2announcements.enabled=true \
        --set k8sClientRateLimit.qps=5 \
        --set k8sClientRateLimit.burst=10 \
        --set kubeProxyReplacement=strict \
        --set k8sServiceHost={{ KUBE_API_SERVER_VIP }} \
        --set k8sServicePort=8443
  register: result
  changed_when: false
- name: Show stdout helm
  debug:
    msg: "{{ result.stdout_lines }}"

- name: copy
  copy:
    src: ./files/cilium/LoadBalancerIPPool.yaml
    dest: ~/
    owner: root
    group: root
    mode: '0644'
  ignore_errors: yes

- name: copy
  copy:
    src: ./files/cilium/L2AnnouncementPolicy.yaml
    dest: ~/
    owner: root
    group: root
    mode: '0644'
  ignore_errors: yes

- name: shell
  shell: kubectl apply -f ~/L2AnnouncementPolicy.yaml

- name: shell
  shell: kubectl apply -f ~/LoadBalancerIPPool.yaml

- name: mv yaml
  shell: mv ~/*.yaml ~/work

- name: Pause for 30 seconds
  pause:
    seconds: 30